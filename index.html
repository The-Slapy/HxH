<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Registro y Reporte HxH</title>
<style>
  :root{--primary:#0f62fe;--muted:#6b7280;--card:#eef3ff;}
  
  body{font-family: 'Segoe UI', Arial, sans-serif; margin:0; background:#f6f7fb; color:#111;}
  
  /* ESTILOS DE PESTA√ëAS (TABS) */
  .tab-nav {
      background: #fff;
      padding: 0 20px;
      border-bottom: 1px solid #ccc;
      display: flex;
      gap: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .tab-btn {
      padding: 15px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: bold;
      color: #666;
      font-size: 16px;
      transition: all 0.3s;
  }
  .tab-btn:hover { background: #f0f0f0; }
  .tab-btn.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
  }
  .tab-content { display: none; padding: 20px; }
  .tab-content.active { display: block; }

  /* ESTILOS ORIGINALES DEL REGISTRO */
  header{background:var(--primary);color:white;padding:15px;border-radius:8px;}
  h1{margin:0;font-size:18px;}
  .controls{margin:15px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  .btn{background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;}
  .btn.alt{background:#22c55e;}
  .btn.warn{background:#f59e0b;}
  .btn.danger{background:#ef4444;}
  .btn.purple{background:#8b5cf6;} /* Nuevo bot√≥n reporte */
  
  textarea, select, input[type="time"], input[type="file"], input[type="date"], input[type="text"]{
    padding:6px;border-radius:6px;border:1px solid #ccc; font-family:Arial, sans-serif;
  }
  textarea{width:100%;min-height:64px; box-sizing: border-box;}
  
  .turno{background:white;padding:12px;margin:10px 0;border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
  .comment{background:var(--card);padding:10px;margin:6px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:flex-start;font-size:14px;}
  .comment-left{flex:1;}
  .comment .hora{color:var(--muted);font-size:12px;margin-left:6px;display:none;}
  .comment .hora.visible{display:inline;}
  .info{font-size:12px;color:#374151;margin-bottom:6px;display:block;}
  .hora-block{margin:8px 0;font-weight:bold;color:#374151;}
  .del-btn{background:#ef4444;color:white;border:none;border-radius:4px;padding:6px 8px;cursor:pointer;}
  #accionOtro{display:none;}

  /* NUEVO ESTILO VISUALIZADOR DE ACCI√ìN */
  .visualizer {
      margin-left: 10px;
      color: var(--primary); 
      font-weight: normal;
      font-size: 14px;
      display: inline-block;
      padding: 0 5px;
      max-width: 300px; /* Limitar el ancho para que no desborde */
  }
  
  #turnosContainer{
    max-height: calc(100vh - 250px);
    overflow-y: auto;
    margin-top: 20px;
    padding-bottom: 20px;
  }

  /* ESTILOS DEL REPORTE HxH */
  .hxh-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .hxh-title { text-align: center; color: #2c3e50; margin-top: 0; }
  .file-upload-wrapper {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      border: 2px dashed #007bff;
      border-radius: 10px;
      background-color: #f0f8ff;
  }
  #btn-copiar {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      display: none;
      width: 100%;
      margin-top: 10px;
      transition: background 0.3s;
  }
  #btn-copiar:hover { background-color: #218838; }
  .hora-bloque {
      margin-bottom: 20px;
      background-color: #fff;
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      overflow: hidden;
  }
  .hora-titulo {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      font-weight: bold;
      font-size: 1.1em;
  }
  .actividad-lista { padding: 0; margin: 0; list-style: none; }
  .actividad-item {
      padding: 10px 15px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: baseline;
  }
  .actividad-item:last-child { border-bottom: none; }
  .tag {
      background-color: #e9ecef;
      color: #495057;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
      margin-right: 8px;
      white-space: nowrap;
  }
  .error-msg { color: #d9534f; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<nav class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('registro')">üìù Registro de Turnos</button>
  <button class="tab-btn" onclick="switchTab('reporte')">üìä Reporte HxH</button>
</nav>

<div id="tab-registro" class="tab-content active">
  <header>
    <h1>Registro de actividades por Turno</h1>
  </header>

  <div class="controls">
    <label>Fecha: <input id="datePicker" type="date"></label>
    <label>Turno:
      <select id="turnoSelector">
        <option value="all">Todos</option>
        <option value="1">Turno 1</option>
        <option value="2">Turno 2</option>
        <option value="3">Turno 3</option>
      </select>
    </label>
  </div>

  <div class="controls">
    <label>Piso:
      <select id="selectPiso">
        <option value="">N/A</option>
        <option value="P1">1</option>
        <option value="P2">2</option>
      </select>
    </label>
    <label>M√°quina:
      <select id="selectMaquina">
        <option value="">N/A</option>
        <option value="PreAOI">PreAOI</option>
        <option value="PAOI">PAOI</option>
        <option value="DAOI">DAOI</option>
        <option value="SPI">SPI</option>
        <option value="AOI">AOI</option>
        <option value="5DX">5DX</option>
      </select>
    </label>
    <label>L√≠nea:
      <select id="selectLinea">
        <option value="">N/A</option>
      </select>
    </label>
    <label>Acci√≥n:
      <select id="selectAccion">
        <option value="">N/A</option>
        <option value="Se asiste a junta de inicio de turno">Junta</option>
        <option value="Se valida Stencil">Stencil</option>
        <option value="Se llena CheckList">CheckList</option>
        <option value="Se pasan tarjetas Golden">Golden</option>
        <option value="Cambio de modelo">Modelo</option>
        <option value="Cambio de lado">Lado</option>
        <option value="Tarjeta Atorada">Atorada</option>
        <option value="Se hace Debug">Debug</option>
        <option value="Problema de Flujo">Flujo</option>
        <option value="M√°quina fallando">Fallando</option>
        <option value="M√°quina funcionando">Funcionando</option>
        <option value="Se asiste a junta de MRB">MRB</option>
        <option value="Se entrega turno">Turno</option>
        <option value="Otro">Otro</option>
      </select>
      <span id="accionVisualizer" class="visualizer"></span>
    </label>
    <input type="text" id="accionOtro" placeholder="Especificar acci√≥n...">
  </div>

  <div class="controls">
    <textarea id="commentText" placeholder="Escribe tu comentario aqu√≠..."></textarea>
  </div>

  <div class="controls">
    <button id="salidaBtn" class="btn warn">Salida comedor</button>
    <button id="regresoBtn" class="btn alt">Regreso comedor</button>
    <button id="exportBtn" class="btn">Exportar JSON</button>
    <button id="exportCsvBtn" class="btn alt">Exportar CSV</button>
    
    <button id="sendToReportBtn" class="btn purple">Generar Reporte HxH</button>
    
    <button id="importBtn" class="btn alt">Importar JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none;">
    <button id="toggleHoraBtn" class="btn">Mostrar horas</button>
    <button id="clearAllBtn" class="btn danger">Limpiar todo</button>
  </div>

  <div class="controls">
    <label>Tipo de hora:
      <select id="horaTipo">
        <option value="actual">Hora actual</option>
        <option value="retro">Hora retroactiva</option>
      </select>
    </label>
    <label>Hora retroactiva:
      <input id="retroTime" type="time" disabled>
    </label>
    <button id="addRetroBtn" class="btn">A√±adir</button>
  </div>

  <div id="turnosContainer"></div>
</div>

<div id="tab-reporte" class="tab-content">
  <div class="hxh-container">
    <h2 class="hxh-title">Generador de Reporte HxH</h2>
    
    <div class="file-upload-wrapper">
        <label for="fileInput" style="font-weight:bold; display:block; margin-bottom:10px;">
            üìÇ Selecciona tu archivo JSON (Opcional):
        </label>
        <input type="file" id="fileInput" accept=".json">
        <p id="errorMsg" class="error-msg"></p>
    </div>

    <button id="btn-copiar" onclick="copiarReporte()">üìã Copiar Reporte al Portapapeles</button>

    <div id="resultadoVisual" class="reporte-container"></div>
  </div>
</div>

<script>
/* ----------------------------------------------------
   LOGICA GLOBAL: PESTA√ëAS
   ---------------------------------------------------- */
function switchTab(tabName) {
    // Ocultar todo
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    // Mostrar seleccionado
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Activar bot√≥n
    const btns = document.querySelectorAll('.tab-btn');
    if(tabName === 'registro') btns[0].classList.add('active');
    else btns[1].classList.add('active');
}

/* ----------------------------------------------------
   LOGICA GLOBAL: REPORTE HxH
   ---------------------------------------------------- */
let textoParaCopiar = "";

// Funci√≥n p√∫blica para generar reporte desde datos directos
window.generarReporteHxH = function(datos) {
    const divResultado = document.getElementById('resultadoVisual');
    const btnCopiar = document.getElementById('btn-copiar');
    const errorMsg = document.getElementById('errorMsg');

    // Limpiar interfaz
    divResultado.innerHTML = "";
    errorMsg.innerText = "";
    textoParaCopiar = "";
    btnCopiar.style.display = "none";
    
    if (!Array.isArray(datos)) {
        errorMsg.innerText = "Error: Los datos no son v√°lidos.";
        return;
    }

    if(datos.length === 0) {
       errorMsg.innerText = "No hay registros para mostrar en esta fecha.";
       return;
    }

    // 1. Ordenar por timestamp
    datos.sort((a, b) => a.timestamp - b.timestamp);

    // 2. Agrupar por hora
    const grupos = {};
    datos.forEach(item => {
        const fecha = new Date(item.timestamp);
        const hora = fecha.getHours();
        const etiquetaHora = `${hora}:00 a ${hora + 1}:00`;

        if (!grupos[etiquetaHora]) { grupos[etiquetaHora] = []; }

        let contextoTags = [];
        if (item.linea) contextoTags.push(`L${item.linea}`);
        if (item.maquina) contextoTags.push(item.maquina);
        
        let partesTexto = [];
        if (item.accion) partesTexto.push(item.accion);
        if (item.text) partesTexto.push(item.text);
        
        let textoFinal = partesTexto.join(" - ");
        if (!textoFinal.trim()) textoFinal = "Registro sin detalle";

        grupos[etiquetaHora].push({ tags: contextoTags, texto: textoFinal });
    });

    // 3. Renderizar
    for (const [rango, actividades] of Object.entries(grupos)) {
        // HTML Visual
        const bloque = document.createElement('div');
        bloque.className = 'hora-bloque';
        
        const titulo = document.createElement('div');
        titulo.className = 'hora-titulo';
        titulo.innerText = rango;
        bloque.appendChild(titulo);

        const lista = document.createElement('ul');
        lista.className = 'actividad-lista';

        actividades.forEach(act => {
            const li = document.createElement('li');
            li.className = 'actividad-item';
            let htmlTags = "";
            if (act.tags.length > 0) {
                htmlTags = `<span class="tag">[${act.tags.join('-')}]</span>`;
            }
            li.innerHTML = `${htmlTags} ${act.texto}`;
            lista.appendChild(li);
        });

        bloque.appendChild(lista);
        divResultado.appendChild(bloque);

        // Texto Plano para Copiar
        textoParaCopiar += `${rango}\n`;
        actividades.forEach(act => {
            let prefix = act.tags.length > 0 ? `[${act.tags.join('-')}] ` : "";
            textoParaCopiar += `${prefix}${act.texto}\n`;
        });
        textoParaCopiar += `\n`; 
    }

    if (Object.keys(grupos).length > 0) {
        btnCopiar.style.display = "block";
    }
}

function copiarReporte() {
    if (!textoParaCopiar) return;
    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const btn = document.getElementById('btn-copiar');
        const originalText = btn.innerText;
        btn.innerText = "¬°Copiado Exitosamente!";
        btn.style.backgroundColor = "#155724";
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.backgroundColor = "#28a745";
        }, 2000);
    }).catch(err => { alert("Error al copiar manual: " + err); });
}

// Carga de archivo manual en la pesta√±a reporte
document.getElementById('fileInput').addEventListener('change', function(evento) {
    const archivo = evento.target.files[0];
    if (!archivo) return;
    const lector = new FileReader();
    lector.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            window.generarReporteHxH(json);
        } catch (error) {
            document.getElementById('errorMsg').innerText = "Error: JSON inv√°lido.";
        }
    };
    lector.readAsText(archivo);
});

/* ----------------------------------------------------
   LOGICA DEL REGISTRO (IIFE ORIGINAL + MODIFICACIONES)
   ---------------------------------------------------- */
(function(){
  const datePicker=document.getElementById("datePicker");
  const turnoSelector=document.getElementById("turnoSelector");
  const turnosContainer=document.getElementById("turnosContainer");
  const commentText=document.getElementById("commentText");
  const salidaBtn=document.getElementById("salidaBtn");
  const regresoBtn=document.getElementById("regresoBtn");
  const exportBtn=document.getElementById("exportBtn");
  const exportCsvBtn=document.getElementById("exportCsvBtn");
  
  /* NUEVO: Bot√≥n enviar a reporte */
  const sendToReportBtn=document.getElementById("sendToReportBtn");
  
  const importBtn=document.getElementById("importBtn");
  const importFile=document.getElementById("importFile");
  const clearAllBtn=document.getElementById("clearAllBtn");
  const addRetroBtn=document.getElementById("addRetroBtn");
  const retroTime=document.getElementById("retroTime");
  const horaTipo=document.getElementById("horaTipo");
  const selectPiso=document.getElementById("selectPiso");
  const selectMaquina=document.getElementById("selectMaquina");
  const selectLinea=document.getElementById("selectLinea");
  const selectAccion=document.getElementById("selectAccion");
  const accionOtro=document.getElementById("accionOtro");
  const accionVisualizer=document.getElementById("accionVisualizer"); /* NUEVO ELEMENTO */
  const toggleHoraBtn=document.getElementById("toggleHoraBtn");

  const prefix="registro_turnos_";
  let mostrarHoras=false;

  function isoDate(d){return d.toISOString().slice(0,10);}
  datePicker.value=isoDate(new Date());
  horaTipo.onchange=function(){ retroTime.disabled = horaTipo.value!=="retro"; }

  function storageKey(dateStr){return prefix+dateStr;}
  function loadData(dateStr){return JSON.parse(localStorage.getItem(storageKey(dateStr))||"[]");}
  function saveData(dateStr,data){localStorage.setItem(storageKey(dateStr),JSON.stringify(data));}

  function getTurno(dateObj){
    const h=dateObj.getHours(), m=dateObj.getMinutes();
    if(h>=6 && h<14) return 1;
    if(h>=14 && (h<21 || (h===21 && m<=30))) return 2;
    return 3;
  }

  selectPiso.onchange=function(){
    selectLinea.innerHTML="";
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="N/A"; 
    selectLinea.appendChild(opt);
    if(selectPiso.value==="P1"){
      ["L17A","L17B","L18","L19"].forEach(l=>{
        const o=document.createElement("option");
        o.value=l; o.textContent=l;
        selectLinea.appendChild(o);
      });
    }
    else if(selectPiso.value==="P2"){
      ["L22","L23"].forEach(l=>{
        const o=document.createElement("option");
        o.value=l; o.textContent=l;
        selectLinea.appendChild(o);
      });
    }
  };

  /* MAPA DE DESCRIPCIONES PARA EL VISUALIZADOR */
  const accionDescriptions = {
    "": "Selecciona una acci√≥n para ver su descripci√≥n.",
    "Se asiste a junta de inicio de turno": "Se asiste a junta de inicio de turno",
    "Se valida Stencil": "Se valida Stencil",
    "Se llena CheckList": "Se llena CheckList",
    "Se pasan tarjetas Golden": "Se pasan tarjetas Golden",
    "Cambio de modelo": "Cambio de modelo",
    "Cambio de lado": "Cambio de lado",
    "Tarjeta Atorada": "Tarjeta Atorada",
    "Se hace Debug": "Se hace Debug",
    "Problema de Flujo": "Problema de Flujo",
    "M√°quina fallando": "M√°quina fallando",
    "M√°quina funcionando": "M√°quina funcionando",
    "Se asiste a junta de MRB": "Se asiste a junta de MRB",
    "Se entrega turno": "Se entrega turno",
    "Otro": "Escribe una descripci√≥n espec√≠fica para esta acci√≥n."
  };

  selectAccion.onchange=function(){
    const selectedValue = selectAccion.value;
    // Mostrar/ocultar input 'Otro'
    accionOtro.style.display = (selectedValue==="Otro") ? "inline-block" : "none";
    
    // Actualizar el visualizador
    const description = accionDescriptions[selectedValue] || "Descripci√≥n no disponible.";
    accionVisualizer.textContent = description;
  };
  
  // Llamar al inicio para mostrar el mensaje inicial
  selectAccion.onchange(); 

  function guardar(texto, fechaHora, omitirInfo=false){
    const dateStr=datePicker.value;
    const data=loadData(dateStr);
    const now=fechaHora || new Date();
    const turno=getTurno(now);
    let accionVal = (selectAccion.value==="Otro") ? accionOtro.value.trim() : selectAccion.value;
    data.push({
      id:Date.now()+Math.random(),
      text:texto,
      turno:turno,
      timestamp:now.getTime(),
      piso: omitirInfo?"":selectPiso.value,
      maquina: omitirInfo?"":selectMaquina.value,
      linea: omitirInfo?"":selectLinea.value,
      accion: omitirInfo?"":accionVal
    });
    saveData(dateStr,data);
    render();
  }

  function render(){
    const dateStr=datePicker.value;
    const data=loadData(dateStr).sort((a,b)=>a.timestamp-b.timestamp);
    const filterTurno=turnoSelector.value;
    const turnosToShow = filterTurno==="all"?[1,2,3]:[parseInt(filterTurno)];
    turnosContainer.innerHTML="";
    turnosToShow.forEach(t=>{
      const div=document.createElement("div");
      div.className="turno";
      div.innerHTML=`<strong>Turno ${t}</strong>`;
      const grupo=data.filter(c=>c.turno===t);
      if(grupo.length===0){ div.innerHTML+="<div>(sin actividad)</div>"; }
      else{
        const bloques={};
        grupo.forEach(c=>{
          const d=new Date(c.timestamp);
          const h=d.getHours();
          const bloque=`${String(h).padStart(2,"0")}:00 - ${String(h+1).padStart(2,"0")}:00`;
          if(!bloques[bloque]) bloques[bloque]=[];
          bloques[bloque].push(c);
        });
        Object.keys(bloques).sort().forEach(b=>{
          const sep=document.createElement("div");
          sep.className="hora-block";
          sep.textContent=b;
          div.appendChild(sep);
          bloques[b].forEach(c=>{
            const cdiv=document.createElement("div");
            cdiv.className="comment";
            const hora=new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
            let info="";
            if(c.piso || c.maquina || c.linea || c.accion){
              info=`<span class="info">[Piso:${c.piso||'N/A'} | M√°q:${c.maquina||'N/A'} | L:${c.linea||'N/A'} | Acc:${c.accion||'N/A'}]</span>`;
            }
            cdiv.innerHTML=`<div class="comment-left">
                               ${info}${c.text}
                               <span class="hora ${mostrarHoras?"visible":""}"> (${hora})</span>
                            </div>
                             <button class="del-btn" onclick="window.__del('${dateStr}',${c.id})">‚ùå</button>`;
            div.appendChild(cdiv);
          });
        });
      }
      turnosContainer.appendChild(div);
    });
  }

  salidaBtn.onclick=function(){guardar("Salida a comedor", null, true);};
  regresoBtn.onclick=function(){guardar("Regreso de comedor", null, true);};

  addRetroBtn.onclick=function(){
    let txt=commentText.value.trim();
    let fechaHora;
    if(horaTipo.value==="actual"){
      fechaHora=new Date();
    }else{
      if(!retroTime.value){alert("Selecciona hora retroactiva"); return;}
      const [h,m]=retroTime.value.split(":").map(Number);
      fechaHora=new Date(datePicker.value+"T00:00:00");
      fechaHora.setHours(h,m);
    }
    guardar(txt, fechaHora, false);
    commentText.value="";
    retroTime.value="";
  };

  exportBtn.onclick=function(){
    const dateStr=datePicker.value;
    const data=loadData(dateStr);
    if(!data.length){alert("No hay datos para exportar"); return;}
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`registro_${dateStr}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  exportCsvBtn.onclick=function(){
    const dateStr=datePicker.value;
    const data=loadData(dateStr);
    if(!data.length){alert("No hay datos para exportar"); return;}
    const headers = ["Fecha","Hora","Turno","Piso","Maquina","Linea","Accion","Comentario"];
    const csvContent = data.map(item => {
        const d = new Date(item.timestamp);
        const datePart = d.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const timePart = d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
        const escape = (text) => `"${String(text).replace(/"/g, '""')}"`;
        return [
            escape(datePart), escape(timePart), escape(item.turno),
            escape(item.piso || 'N/A'), escape(item.maquina || 'N/A'),
            escape(item.linea || 'N/A'), escape(item.accion || 'N/A'), escape(item.text)
        ].join(',');
    }).join('\n');
    const csv = headers.join(',') + '\n' + csvContent;
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`registro_${dateStr}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
  
  /* LOGICA NUEVA: ENVIAR DATOS DIRECTOS A REPORTE HxH */
  sendToReportBtn.onclick=function(){
      const dateStr=datePicker.value;
      const data=loadData(dateStr);
      
      // Llamar a la funci√≥n global del reporte
      window.generarReporteHxH(data);
      
      // Cambiar de pesta√±a
      switchTab('reporte');
  };

  importBtn.onclick=function(){ importFile.click(); };
  importFile.onchange=function(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=function(ev){
      try{const data=JSON.parse(ev.target.result);
      saveData(datePicker.value,data);
      render();}
      catch(err){alert("Archivo JSON inv√°lido");}
    };
    reader.readAsText(file); importFile.value="";
  };
  
  clearAllBtn.onclick=function(){
    if(confirm("¬øSeguro que quieres borrar todo el registro de este d√≠a?")){
      localStorage.removeItem(storageKey(datePicker.value));
      render();
    }
  };

  toggleHoraBtn.onclick=function(){
    mostrarHoras=!mostrarHoras;
    toggleHoraBtn.textContent=mostrarHoras?"Ocultar horas":"Mostrar horas";
    render();
  };

  window.__del=function(dateStr,id){
    const data=loadData(dateStr).filter(c=>c.id!==id);
    saveData(dateStr,data); render();
  };

  datePicker.onchange=render;
  turnoSelector.onchange=render;
  render();
})();
</script>
</body>
</html>
